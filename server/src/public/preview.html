<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Preview</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { background:#071022; color:#e6eef8; font-family:system-ui, -apple-system, Roboto, Arial; padding:18px; }
    .card{max-width:900px;margin:18px auto;background:#0b1220;padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
    pre{white-space:pre-wrap;background:#071126;padding:12px;border-radius:8px;overflow:auto}
    a.big{display:inline-block;padding:10px 14px;background:#2563eb;color:#fff;border-radius:8px;text-decoration:none;margin-bottom:12px}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Preview</h2>
    <div id="content"><em>Loading preview...</em></div>
    <div id="meta" style="margin-top:12px;color:#9aa6b2;font-size:13px"></div>
  </div>

<script>
(async function(){
  const qp = new URLSearchParams(window.location.search);
  let id = qp.get('sessionId') || location.hash.replace('#','') || '';
  if (!id) { document.getElementById('content').innerHTML = '<p>No session id provided</p>'; return; }

  try {
    const res = await fetch('/api/session/' + encodeURIComponent(id));
    if (!res.ok) { document.getElementById('content').innerHTML = '<p>Preview not found or expired.</p>'; return; }
    const json = await res.json();
    const project = json?.data || json?.project || (json?.session && json.session.data) || null;
    document.getElementById('title').innerText = project?.title || 'Preview';

    // Prefer snack url (runnable RN in Snack)
    if (json?.snackUrl) {
      document.getElementById('content').innerHTML =
        '<a class="big" href="'+json.snackUrl+'" target="_blank">Open Snack preview (runs RN in browser)</a>' +
        '<p style="margin-top:8px;color:#9aa6b2">Or scan the QR code on your original UI to open on device.</p>' +
        (project?.code ? '<h4>Generated Code</h4><pre>'+escapeHtml(project.code)+'</pre>' : '');
    } else if (project?.html) {
      // If AI returned raw HTML, inject it (safe because this is your dev environment)
      document.getElementById('content').innerHTML = project.html;
    } else if (project?.code) {
      // Show code plus instructions to run via Expo/Snack
      document.getElementById('content').innerHTML =
        '<p>This session contains React Native code. To run it on device, copy the code into an Expo project or use Snack.</p>' +
        '<pre>'+escapeHtml(project.code)+'</pre>';
    } else {
      document.getElementById('content').innerHTML = '<pre>'+escapeHtml(JSON.stringify(json, null, 2))+'</pre>';
    }

    document.getElementById('meta').innerText = 'Session: ' + id + (json.createdAt ? ' â€¢ Created ' + new Date(json.createdAt).toLocaleString() : '');
  } catch (err) {
    console.error(err);
    document.getElementById('content').innerHTML = '<p>Failed to load preview</p>';
  }

  function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
})();
</script>
</body>
</html>
